<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cognitive Dashboard · VibeSync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100">
    <div class="min-h-screen flex flex-col">
      <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur">
        <div class="mx-auto max-w-7xl px-6 py-5 flex flex-wrap items-center justify-between gap-4">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-cyan-400">Cognitive Dashboard</p>
            <h1 class="text-2xl font-semibold text-white">VibeSync · Decision Graph</h1>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-xs uppercase tracking-[0.3em] text-slate-400" for="vibeFilter">VibeID</label>
            <input
              id="vibeFilter"
              type="text"
              placeholder="Filter by VibeID"
              class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:border-cyan-400 focus:outline-none"
            />
          </div>
        </div>
      </header>

      <main class="flex-1">
        <div class="mx-auto max-w-7xl px-6 py-6 grid gap-6 lg:grid-cols-[260px_1fr_320px]">
          <aside class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <div class="flex items-center justify-between">
              <h2 class="text-sm font-semibold text-white">Sync-Points</h2>
              <span id="syncTotal" class="text-xs text-slate-400">0 nodes</span>
            </div>
            <div class="mt-4 space-y-4" id="syncPoints"></div>
          </aside>

          <section class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 flex flex-col">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-sm font-semibold text-white">Decision DAG</h2>
                <p class="text-xs text-slate-400">Nodes = event_id · Links = parents[]</p>
              </div>
              <button
                id="refreshBtn"
                class="rounded-lg border border-cyan-500/40 bg-cyan-500/10 px-3 py-1.5 text-xs font-medium text-cyan-300 hover:bg-cyan-500/20"
              >
                Refresh
              </button>
            </div>
            <div class="mt-4 flex-1 rounded-xl border border-slate-800 bg-slate-950/60">
              <svg id="graph" class="h-full w-full"></svg>
            </div>
          </section>

          <aside class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
            <h2 class="text-sm font-semibold text-white">Event Intelligence</h2>
            <div id="detailPanel" class="mt-4 space-y-4 text-sm text-slate-200">
              <p class="text-slate-400">Clique un nœud pour explorer l'intent, rationale & fichiers.</p>
            </div>
          </aside>
        </div>
      </main>
    </div>

    <script>
      const SUPABASE_URL = "https://eynfodzjjwyroyetrwlt.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5bmZvZHpqand5cm95ZXRyd2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNzY3OTAsImV4cCI6MjA4NTc1Mjc5MH0.0tJ6rBG9gdSwvam1vNOplpBAjNGiXrV2a_BT_OYoQEc";

      const headers = {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        "Content-Type": "application/json",
      };

      const state = {
        nodes: [],
        links: [],
        vibeFilter: "",
      };

      const vibeFilterInput = document.getElementById("vibeFilter");
      const detailPanel = document.getElementById("detailPanel");
      const syncPoints = document.getElementById("syncPoints");
      const syncTotal = document.getElementById("syncTotal");
      const refreshBtn = document.getElementById("refreshBtn");

      function normalizeParents(value) {
        if (!value) return [];
        if (Array.isArray(value)) return value;
        if (typeof value === "string") {
          try {
            const parsed = JSON.parse(value);
            return Array.isArray(parsed) ? parsed : [];
          } catch (error) {
            return value.split(",").map((item) => item.trim()).filter(Boolean);
          }
        }
        return [];
      }

      function getSyncLevel(row) {
        if (row.sync_level) return row.sync_level.toUpperCase();
        if (row.status) {
          const match = row.status.match(/L[123]/i);
          if (match) return match[0].toUpperCase();
        }
        return "L1";
      }

      function formatFiles(files) {
        if (!files || !files.length) return "—";
        return files.join(", ");
      }

      function renderDetail(node) {
        detailPanel.innerHTML = `
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <h3 class="text-base font-semibold text-white">${node.event_id}</h3>
              <span class="text-xs text-cyan-300">${getSyncLevel(node)}</span>
            </div>
            <p class="text-xs text-slate-400">VibeID · ${node.vibe_id || "—"}</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Intent</p>
            <p class="mt-1 text-sm text-slate-200">${node.intent || "—"}</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Rationale</p>
            <p class="mt-1 text-sm text-slate-200">${node.rationale || "—"}</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Files</p>
            <p class="mt-1 text-sm text-slate-200">${formatFiles(node.files_touched)}</p>
          </div>
        `;
      }

      function renderSyncPoints(nodes) {
        const grouped = nodes.reduce(
          (acc, node) => {
            const level = getSyncLevel(node);
            acc[level] = acc[level] || [];
            acc[level].push(node);
            return acc;
          },
          { L1: [], L2: [], L3: [] }
        );

        syncTotal.textContent = `${nodes.length} nodes`;
        syncPoints.innerHTML = ["L1", "L2", "L3"]
          .map(
            (level) => `
              <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3">
                <div class="flex items-center justify-between">
                  <h3 class="text-xs font-semibold text-cyan-300">${level}</h3>
                  <span class="text-xs text-slate-400">${grouped[level].length}</span>
                </div>
                <ul class="mt-3 space-y-2 text-xs text-slate-300">
                  ${grouped[level]
                    .slice(0, 6)
                    .map(
                      (node) =>
                        `<li class="flex items-center justify-between">
                          <button class="text-left text-slate-200 hover:text-white" data-node="${node.event_id}">${node.event_id}</button>
                          <span class="text-[10px] text-slate-500">${node.vibe_id || "—"}</span>
                        </li>`
                    )
                    .join("")}
                </ul>
              </div>
            `
          )
          .join("");

        syncPoints.querySelectorAll("button[data-node]").forEach((button) => {
          button.addEventListener("click", () => {
            const match = nodes.find((node) => node.event_id === button.dataset.node);
            if (match) renderDetail(match);
          });
        });
      }

      function renderGraph(nodes, links) {
        const svg = d3.select("#graph");
        svg.selectAll("*").remove();

        const width = svg.node().clientWidth || 800;
        const height = svg.node().clientHeight || 600;

        const simulation = d3
          .forceSimulation(nodes)
          .force("link", d3.forceLink(links).id((d) => d.event_id).distance(120))
          .force("charge", d3.forceManyBody().strength(-280))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("collision", d3.forceCollide(28));

        const link = svg
          .append("g")
          .attr("stroke", "#334155")
          .attr("stroke-width", 1.2)
          .selectAll("line")
          .data(links)
          .enter()
          .append("line")
          .attr("stroke-opacity", 0.7);

        const node = svg
          .append("g")
          .selectAll("g")
          .data(nodes)
          .enter()
          .append("g")
          .style("cursor", "pointer")
          .on("click", (_, d) => renderDetail(d));

        node
          .append("circle")
          .attr("r", 18)
          .attr("fill", (d) => {
            const level = getSyncLevel(d);
            if (level === "L3") return "#22d3ee";
            if (level === "L2") return "#38bdf8";
            return "#0ea5e9";
          })
          .attr("stroke", "#0f172a")
          .attr("stroke-width", 2);

        node
          .append("text")
          .text((d) => d.event_id.slice(0, 6))
          .attr("fill", "#0f172a")
          .attr("font-size", "10px")
          .attr("text-anchor", "middle")
          .attr("dy", 4);

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          node.attr("transform", (d) => `translate(${d.x},${d.y})`);
        });
      }

      function buildGraph(ledger, decisions) {
        const decisionByLedger = new Map(decisions.map((item) => [item.ledger_id, item]));
        const nodes = ledger.map((row) => {
          const event_id = row.event_id || row.id;
          const decision = decisionByLedger.get(row.id) || {};
          return {
            ...row,
            event_id,
            parents: normalizeParents(row.parents),
            rationale: row.rationale || decision.rationale,
            intent: row.intent || decision.decision,
          };
        });

        const nodeIds = new Set(nodes.map((node) => node.event_id));
        const links = nodes
          .flatMap((node) =>
            node.parents.map((parent) => ({ source: parent, target: node.event_id }))
          )
          .filter((link) => nodeIds.has(link.source) && nodeIds.has(link.target));

        return { nodes, links };
      }

      function applyFilter() {
        const vibeFilter = state.vibeFilter.toLowerCase();
        const filteredNodes = vibeFilter
          ? state.nodes.filter((node) => (node.vibe_id || "").toLowerCase().includes(vibeFilter))
          : state.nodes;
        const filteredIds = new Set(filteredNodes.map((node) => node.event_id));
        const filteredLinks = state.links.filter(
          (link) => filteredIds.has(link.source) && filteredIds.has(link.target)
        );

        renderSyncPoints(filteredNodes);
        renderGraph(filteredNodes, filteredLinks);
      }

      async function fetchLedgerData() {
        const ledgerRequest = axios.get(`${SUPABASE_URL}/rest/v1/context_ledger`, {
          headers,
          params: {
            select:
              "id,event_id,parents,vibe_id,agent_id,intent,files_touched,status,created_at,sync_level",
            order: "created_at.desc",
            limit: 250,
          },
        });

        const decisionRequest = axios.get(`${SUPABASE_URL}/rest/v1/decision_graph`, {
          headers,
          params: {
            select: "id,ledger_id,decision,rationale,created_at",
            order: "created_at.desc",
            limit: 250,
          },
        });

        const [ledgerResponse, decisionResponse] = await Promise.all([
          ledgerRequest,
          decisionRequest,
        ]);

        return {
          ledger: ledgerResponse.data || [],
          decisions: decisionResponse.data || [],
        };
      }

      async function refresh() {
        refreshBtn.disabled = true;
        refreshBtn.textContent = "Loading...";

        try {
          const { ledger, decisions } = await fetchLedgerData();
          if (!ledger.length) {
            throw new Error("No ledger data");
          }
          const graph = buildGraph(ledger, decisions);
          state.nodes = graph.nodes;
          state.links = graph.links;
        } catch (error) {
          state.nodes = [
            {
              id: "sample-1",
              event_id: "sample-1",
              parents: [],
              vibe_id: "vibe-demo",
              intent: "Bootstrap cognitive dashboard",
              rationale: "Fallback sample to keep UI alive",
              files_touched: [".sys/dashboard/index.html"],
              status: "L2",
            },
            {
              id: "sample-2",
              event_id: "sample-2",
              parents: ["sample-1"],
              vibe_id: "vibe-demo",
              intent: "Render DAG in D3",
              rationale: "Show relationships between events",
              files_touched: [".sys/dashboard/index.html"],
              status: "L3",
            },
          ];
          state.links = [{ source: "sample-1", target: "sample-2" }];
        } finally {
          refreshBtn.disabled = false;
          refreshBtn.textContent = "Refresh";
          applyFilter();
        }
      }

      vibeFilterInput.addEventListener("input", (event) => {
        state.vibeFilter = event.target.value;
        applyFilter();
      });

      refreshBtn.addEventListener("click", () => refresh());

      refresh();
    </script>
  </body>
</html>
